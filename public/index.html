<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eWeLink MCP Server</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .alert-error {
            background: #fee;
            color: #c53030;
            border: 1px solid #fed7d7;
        }
        
        .alert-success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
        }
        
        .dashboard {
            min-height: 100vh;
            background: #f7fafc;
        }
        
        .navbar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            color: #2d3748;
            font-size: 1.5rem;
        }
        
        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .navbar .user-info span {
            color: #4a5568;
        }
        
        .navbar .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #4a5568;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-approved {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-pending {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-paused {
            background: #fef5e7;
            color: #744210;
        }
        
        .action-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .btn-pause {
            background: #fef5e7;
            color: #744210;
        }
        
        .btn-resume {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .btn-suspend {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Form -->
        <div id="loginContainer" class="container">
            <div class="header">
                <h1>eWeLink MCP Server</h1>
                <p>Sign in to your account</p>
            </div>
            
            <div id="alertContainer"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="userType">User Type</label>
                    <select id="userType" required>
                        <option value="tenant_user">Tenant User</option>
                        <option value="tenant_admin">Tenant Admin</option>
                        <option value="global_admin">Global Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">Sign In</button>
            </form>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboardContainer" class="dashboard hidden">
            <nav class="navbar">
                <h1 id="dashboardTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="userWelcome">Welcome, User</span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </nav>
            
            <main class="main-content">
                <div id="alertDashboard"></div>
                
                <!-- Global Admin Dashboard -->
                <div id="globalAdminDashboard" class="hidden">
                    <div class="tabs">
                        <button class="tab active" data-tab="overview">Overview</button>
                        <button class="tab" data-tab="tenants">Tenants</button>
                        <button class="tab" data-tab="users">Users</button>
                        <button class="tab" data-tab="settings">Settings</button>
                    </div>
                    
                    <div id="overview" class="tab-content active">
                        <h2 style="margin-bottom: 1.5rem;">System Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Tenants</h3>
                                <div class="value" id="totalTenants">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Users</h3>
                                <div class="value" id="totalUsers">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>System Status</h3>
                                <div class="value" style="font-size: 1.2rem; color: #38a169;">Healthy</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tenants" class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>Tenant Management</h2>
                            <button class="btn" style="width: auto;" id="refreshTenants">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tenant</th>
                                        <th>Status</th>
                                        <th>Users</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantsTableBody">
                                    <tr>
                                        <td colspan="4" class="loading">Loading tenants...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="users" class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>User Management</h2>
                            <button class="btn" style="width: auto;" id="refreshUsers">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Tenant</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="4" class="loading">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="settings" class="tab-content">
                        <h2 style="margin-bottom: 1.5rem;">System Settings</h2>
                        <div class="table-container" style="padding: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Global Configuration</h3>
                            <p style="color: #666; margin-bottom: 2rem;">System-wide settings and configuration options.</p>
                            
                            <div class="form-group">
                                <label>System Name</label>
                                <input type="text" value="eWeLink MCP Server" style="width: 100%; max-width: 400px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Default Tenant Status</label>
                                <select style="width: 100%; max-width: 400px;">
                                    <option value="PENDING">Pending Approval</option>
                                    <option value="APPROVED">Auto-Approve</option>
                                </select>
                            </div>
                            
                            <button class="btn" style="width: auto; margin-top: 1rem;">Save Settings</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tenant Admin Dashboard -->
                <div id="tenantAdminDashboard" class="hidden">
                    <div class="tabs">
                        <button class="tab active" data-tab="tenant-overview">Overview</button>
                        <button class="tab" data-tab="tenant-users">Users</button>
                        <button class="tab" data-tab="oauth-config">OAuth Config</button>
                        <button class="tab" data-tab="mcp-config">MCP</button>
                    </div>
                    
                    <div id="tenant-overview" class="tab-content active">
                        <h2 style="margin-bottom: 1.5rem;">Tenant Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Users</h3>
                                <div class="value" id="tenantTotalUsers">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Connected Devices</h3>
                                <div class="value" id="tenantConnectedDevices">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>OAuth Status</h3>
                                <div class="value" style="font-size: 1.2rem; color: #e53e3e;" id="tenantOAuthStatus">Not Connected</div>
                            </div>
                        </div>
                        
                        <div class="table-container" style="margin-top: 2rem;">
                            <h3 style="padding: 1rem; margin: 0; background: #f7fafc; border-bottom: 1px solid #e2e8f0;">Recent Activity</h3>
                            <div style="padding: 2rem; text-align: center; color: #666;">
                                No recent activity
                            </div>
                        </div>
                    </div>
                    
                    <div id="tenant-users" class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>User Management</h2>
                            <button class="btn" style="width: auto;" id="refreshTenantUsers">Refresh</button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Last Active</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantUsersTableBody">
                                    <tr>
                                        <td colspan="4" class="loading">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="oauth-config" class="tab-content">
                        <h2 style="margin-bottom: 1.5rem;">OAuth Configuration</h2>
                        <div class="table-container" style="padding: 2rem;">
                            <h3 style="margin-bottom: 1rem;">eWeLink Integration</h3>
                            <p style="color: #666; margin-bottom: 2rem;">Configure your eWeLink OAuth application for device integration.</p>
                            
                            <div class="form-group">
                                <label>Client ID</label>
                                <input type="text" id="oauthClientId" placeholder="Enter your eWeLink Client ID" style="width: 100%; max-width: 400px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Client Secret</label>
                                <input type="password" id="oauthClientSecret" placeholder="Enter your eWeLink Client Secret" style="width: 100%; max-width: 400px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Callback URL</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="oauthCallbackUrl" readonly style="width: 100%; max-width: 400px; background: #f7fafc;">
                                    <button class="btn" style="width: auto;" id="copyCallbackUrl">Copy</button>
                                </div>
                                <small style="color: #666; margin-top: 0.5rem; display: block;">Use this URL in your eWeLink OAuth app configuration</small>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button class="btn" style="width: auto;" id="saveOAuthConfig">Save Configuration</button>
                                <button class="btn" style="width: auto; background: #38a169;" id="testOAuthConnection">Test Connection</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mcp-config" class="tab-content">
                        <h2 style="margin-bottom: 1.5rem;">MCP Configuration</h2>
                        <div class="table-container" style="padding: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Model Context Protocol</h3>
                            <p style="color: #666; margin-bottom: 2rem;">Configure MCP access for AI assistant integration.</p>
                            
                            <div class="form-group">
                                <label>MCP Endpoint URL</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="mcpEndpointUrl" readonly style="width: 100%; max-width: 400px; background: #f7fafc;">
                                    <button class="btn" style="width: auto;" id="copyMcpUrl">Copy</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>API Key</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="mcpApiKey" readonly style="width: 100%; max-width: 400px; background: #f7fafc;">
                                    <button class="btn" style="width: auto;" id="regenerateApiKey">Regenerate</button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem;">
                                <button class="btn" style="width: auto;" id="testMcpConnection">Test MCP Connection</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tenant User Dashboard -->
                <div id="tenantUserDashboard" class="hidden">
                    <div class="tabs">
                        <button class="tab active" data-tab="user-devices">My Devices</button>
                        <button class="tab" data-tab="user-ewelink">eWeLink</button>
                        <button class="tab" data-tab="user-mcp">MCP Access</button>
                    </div>
                    
                    <div id="user-devices" class="tab-content active">
                        <h2 style="margin-bottom: 1.5rem;">My Devices</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Devices</h3>
                                <div class="value" id="userTotalDevices">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Online Devices</h3>
                                <div class="value" id="userOnlineDevices">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Connection Status</h3>
                                <div class="value" style="font-size: 1.2rem; color: #e53e3e;" id="userConnectionStatus">Not Connected</div>
                            </div>
                        </div>
                        
                        <div class="table-container" style="margin-top: 2rem;">
                            <div style="padding: 2rem; text-align: center;">
                                <h3 style="color: #666; margin-bottom: 1rem;">No devices found</h3>
                                <p style="color: #666; margin-bottom: 2rem;">Connect your eWeLink account to start managing your devices.</p>
                                <button class="btn" style="width: auto;">Connect eWeLink Account</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="user-ewelink" class="tab-content">
                        <h2 style="margin-bottom: 1.5rem;">eWeLink Integration</h2>
                        <div class="table-container" style="padding: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Account Connection</h3>
                            <p style="color: #666; margin-bottom: 2rem;">Connect your eWeLink account to access and control your smart devices.</p>
                            
                            <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                                <h4 style="margin-bottom: 1rem; color: #2d3748;">Connection Status</h4>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span class="status-badge status-pending">Not Connected</span>
                                    <span style="color: #666;">No eWeLink account connected</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" style="width: auto;">Connect Account</button>
                                <button class="btn" style="width: auto; background: #718096;">Refresh Status</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="user-mcp" class="tab-content">
                        <h2 style="margin-bottom: 1.5rem;">MCP Access</h2>
                        <div class="table-container" style="padding: 2rem;">
                            <h3 style="margin-bottom: 1rem;">AI Assistant Integration</h3>
                            <p style="color: #666; margin-bottom: 2rem;">Use your personal MCP endpoint to connect AI assistants to your devices.</p>
                            
                            <div class="form-group">
                                <label>Your MCP Endpoint URL</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="userMcpUrl" readonly style="width: 100%; max-width: 500px; background: #f7fafc;">
                                    <button class="btn" style="width: auto;" id="copyUserMcpUrl">Copy My MCP URL</button>
                                </div>
                                <small style="color: #666; margin-top: 0.5rem; display: block;">Use this URL to connect AI assistants like Claude, ChatGPT, or custom applications</small>
                            </div>
                            
                            <div style="background: #f0fff4; padding: 1.5rem; border-radius: 8px; margin: 2rem 0; border: 1px solid #c6f6d5;">
                                <h4 style="margin-bottom: 1rem; color: #22543d;">How to use your MCP endpoint:</h4>
                                <ol style="color: #2f855a; margin-left: 1.5rem;">
                                    <li>Copy your MCP endpoint URL above</li>
                                    <li>Add it to your AI assistant's MCP configuration</li>
                                    <li>Start controlling your devices through natural language</li>
                                </ol>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" style="width: auto;" id="testUserMcpConnection">Test Connection</button>
                                <button class="btn" style="width: auto; background: #718096;">View Documentation</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let authToken = null;
        let globalAdminData = { tenants: [], users: [] };

        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginForm = document.getElementById('loginForm');
        const alertContainer = document.getElementById('alertContainer');
        const alertDashboard = document.getElementById('alertDashboard');

        // Utility functions
        function showAlert(message, type = 'error', container = alertContainer) {
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function makeRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            return fetch(url, { ...defaultOptions, ...options })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                });
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            const endpoint = userType === 'global_admin' ? '/api/global-admin/login' :
                           userType === 'tenant_admin' ? '/api/tenant-admin/login' :
                           '/api/tenant-user/login';

            makeRequest(endpoint, {
                method: 'POST',
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                authToken = response.token;
                // Handle different response structures
                const userData = response.user || response.admin || response;
                currentUser = { ...userData, userType };
                showDashboard();
                showAlert('Login successful!', 'success', alertDashboard);
                
                if (userType === 'global_admin') {
                    loadGlobalAdminData();
                } else if (userType === 'tenant_admin') {
                    loadTenantAdminOAuthConfig(); // Load OAuth config which generates callback URL
                }
            })
            .catch(error => {
                showAlert(error.error || 'Login failed');
            })
            .finally(() => {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            });
        }

        function logout() {
            currentUser = null;
            authToken = null;
            globalAdminData = { tenants: [], users: [] };
            
            loginContainer.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            showAlert('Logged out successfully!', 'success');
        }

        // Dashboard functions
        function showDashboard() {
            loginContainer.classList.add('hidden');
            dashboardContainer.classList.remove('hidden');
            
            const dashboardTitle = document.getElementById('dashboardTitle');
            const userWelcome = document.getElementById('userWelcome');
            
            if (currentUser.userType === 'global_admin') {
                dashboardTitle.textContent = 'Global Admin Dashboard';
                userWelcome.textContent = `Welcome, ${currentUser.name || currentUser.email}`;
                document.getElementById('globalAdminDashboard').classList.remove('hidden');
                document.getElementById('tenantAdminDashboard').classList.add('hidden');
                document.getElementById('tenantUserDashboard').classList.add('hidden');
            } else if (currentUser.userType === 'tenant_admin') {
                dashboardTitle.textContent = 'Tenant Admin Dashboard';
                userWelcome.textContent = `Welcome, ${currentUser.name || currentUser.email}`;
                document.getElementById('globalAdminDashboard').classList.add('hidden');
                document.getElementById('tenantAdminDashboard').classList.remove('hidden');
                document.getElementById('tenantUserDashboard').classList.add('hidden');
                loadTenantAdminUsers();
                loadTenantAdminMcpUrl();
                loadTenantAdminOAuthConfig();
            } else {
                dashboardTitle.textContent = 'User Dashboard';
                userWelcome.textContent = `Welcome, ${currentUser.name || currentUser.email}`;
                document.getElementById('globalAdminDashboard').classList.add('hidden');
                document.getElementById('tenantAdminDashboard').classList.add('hidden');
                document.getElementById('tenantUserDashboard').classList.remove('hidden');
                loadTenantUserMcpUrl();
            }
        }

        // MCP URL loading functions
        function loadTenantAdminMcpUrl() {
            makeRequest('/api/tenant-admin/mcp-url')
                .then(data => {
                    if (data.mcpUrl) {
                        document.getElementById('mcpEndpointUrl').value = data.mcpUrl;
                    }
                    // Generate a simple API key for demo purposes
                    const apiKey = `ta_${currentUser.tenantId}_${Date.now().toString(36)}`;
                    document.getElementById('mcpApiKey').value = apiKey;
                })
                .catch(error => {
                    console.error('Failed to load MCP URL:', error);
                    showAlert('Failed to load MCP configuration', 'error', alertDashboard);
                });
        }

        function loadTenantUserMcpUrl() {
            fetch(`/api/enhanced-mcp/discover?email=${encodeURIComponent(currentUser.email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.servers && data.servers.length > 0) {
                        const server = data.servers.find(s => s.userType === 'tenant_user');
                        if (server) {
                            document.getElementById('userMcpUrl').value = server.url;
                        }
                    }
                })
                .catch(error => {
                    console.error('Failed to load MCP URL:', error);
                });
        }

        // OAuth configuration functions
        function loadTenantAdminOAuthConfig() {
            // Generate OAuth callback URL based on tenant domain
            if (currentUser && currentUser.tenant) {
                const baseUrl = window.location.origin;
                const tenantDomain = currentUser.tenant.domain || 'default';
                const tenantSlug = tenantDomain.split('.')[0]; // Extract first part of domain
                const callbackUrl = `${baseUrl}/oauth/callback/${tenantSlug}`;
                document.getElementById('oauthCallbackUrl').value = callbackUrl;
            }

            // Load existing OAuth configuration
            makeRequest('/api/tenant-admin/oauth-config')
                .then(data => {
                    if (data.clientId) {
                        document.getElementById('oauthClientId').value = data.clientId;
                    }
                    if (data.clientSecret) {
                        document.getElementById('oauthClientSecret').value = '••••••••••••';
                    }
                })
                .catch(error => {
                    console.log('No existing OAuth config found');
                });
        }

        function saveOAuthConfig() {
            const clientId = document.getElementById('oauthClientId').value;
            const clientSecret = document.getElementById('oauthClientSecret').value;

            if (!clientId || !clientSecret) {
                showAlert('Please enter both Client ID and Client Secret', 'error', alertDashboard);
                return;
            }

            makeRequest('/api/tenant-admin/oauth-config', {
                method: 'POST',
                body: JSON.stringify({
                    clientId: clientId,
                    clientSecret: clientSecret
                })
            })
            .then(response => {
                showAlert('OAuth configuration saved successfully!', 'success', alertDashboard);
                // Reload OAuth config to show the callback URL
                loadTenantAdminOAuthConfig();
            })
            .catch(error => {
                showAlert('Failed to save OAuth configuration', 'error', alertDashboard);
            });
        }

        function testOAuthConnection() {
            makeRequest('/api/tenant-admin/oauth-test')
                .then(response => {
                    if (response.success) {
                        showAlert('OAuth connection successful!', 'success', alertDashboard);
                    } else {
                        showAlert('OAuth connection failed: ' + (response.error || 'Unknown error'), 'error', alertDashboard);
                    }
                })
                .catch(error => {
                    showAlert('OAuth connection test failed', 'error', alertDashboard);
                });
        }

        // Global Admin functions
        function loadGlobalAdminData() {
            Promise.all([
                makeRequest('/api/global-admin/tenants'),
                makeRequest('/api/global-admin/users')
            ])
            .then(([tenantsResponse, usersResponse]) => {
                globalAdminData.tenants = tenantsResponse.tenants || [];
                globalAdminData.users = usersResponse.users || [];
                updateGlobalAdminUI();
            })
            .catch(error => {
                showAlert('Failed to load admin data', 'error', alertDashboard);
            });
        }

        // Tenant Admin functions
        function loadTenantAdminUsers() {
            makeRequest('/api/tenant-admin/users')
                .then(response => {
                    const users = response.users || [];
                    updateTenantAdminUsersUI(users);
                })
                .catch(error => {
                    console.error('Failed to load tenant users:', error);
                    showAlert('Failed to load users', 'error', alertDashboard);
                    const tableBody = document.getElementById('tenantUsersTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">Failed to load users</td></tr>';
                    }
                });
        }

        function updateTenantAdminUsersUI(users) {
            const tableBody = document.getElementById('tenantUsersTableBody');
            if (!tableBody) return;

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No users found</td></tr>';
            } else {
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${user.name || 'Unnamed User'}</div>
                            <div style="color: #666; font-size: 0.9rem;">${user.email}</div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            <span class="status-badge status-${user.status.toLowerCase()}">${user.status}</span>
                        </td>
                        <td>${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never'}</td>
                    </tr>
                `).join('');
            }
        }

        function updateGlobalAdminUI() {
            // Update stats
            document.getElementById('totalTenants').textContent = globalAdminData.tenants.length;
            document.getElementById('totalUsers').textContent = globalAdminData.users.length;
            
            // Update tenants table
            const tenantsTableBody = document.getElementById('tenantsTableBody');
            if (globalAdminData.tenants.length === 0) {
                tenantsTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No tenants found</td></tr>';
            } else {
                tenantsTableBody.innerHTML = globalAdminData.tenants.map(tenant => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${tenant.name}</div>
                            <div style="color: #666; font-size: 0.9rem;">${tenant.domain}</div>
                        </td>
                        <td>
                            <span class="status-badge status-${tenant.status.toLowerCase()}">${tenant.status}</span>
                        </td>
                        <td>${tenant.userCount || 0} users</td>
                        <td>
                            ${tenant.status === 'APPROVED' ? `
                                <button class="action-btn btn-pause" onclick="pauseTenant('${tenant.id}')">Pause</button>
                                <button class="action-btn btn-suspend" onclick="suspendTenant('${tenant.id}')">Suspend</button>
                            ` : tenant.status === 'PAUSED' ? `
                                <button class="action-btn btn-resume" onclick="resumeTenant('${tenant.id}')">Resume</button>
                                <button class="action-btn btn-suspend" onclick="suspendTenant('${tenant.id}')">Suspend</button>
                            ` : `
                                <button class="action-btn btn-resume" onclick="resumeTenant('${tenant.id}')">Reactivate</button>
                            `}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update users table
            const usersTableBody = document.getElementById('usersTableBody');
            if (globalAdminData.users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No users found</td></tr>';
            } else {
                usersTableBody.innerHTML = globalAdminData.users.map(user => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${user.name || 'Unnamed User'}</div>
                            <div style="color: #666; font-size: 0.9rem;">${user.email}</div>
                        </td>
                        <td>
                            <span class="status-badge ${user.role === 'Global Admin' ? 'status-pending' : user.role === 'Tenant Admin' ? 'status-paused' : 'status-approved'}">${user.role}</span>
                        </td>
                        <td>${user.tenantName || 'System'}</td>
                        <td>
                            <span class="status-badge ${user.status === 'ACTIVE' ? 'status-approved' : 'status-pending'}">${user.status}</span>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Tenant management functions
        function pauseTenant(tenantId) {
            makeRequest(`/api/global-admin/tenants/${tenantId}/pause`, { method: 'PUT' })
                .then(() => {
                    showAlert('Tenant paused successfully', 'success', alertDashboard);
                    loadGlobalAdminData();
                })
                .catch(error => {
                    showAlert('Failed to pause tenant', 'error', alertDashboard);
                });
        }

        function resumeTenant(tenantId) {
            makeRequest(`/api/global-admin/tenants/${tenantId}/resume`, { method: 'PUT' })
                .then(() => {
                    showAlert('Tenant resumed successfully', 'success', alertDashboard);
                    loadGlobalAdminData();
                })
                .catch(error => {
                    showAlert('Failed to resume tenant', 'error', alertDashboard);
                });
        }

        function suspendTenant(tenantId) {
            makeRequest(`/api/global-admin/tenants/${tenantId}/suspend`, { method: 'PUT' })
                .then(() => {
                    showAlert('Tenant suspended successfully', 'success', alertDashboard);
                    loadGlobalAdminData();
                })
                .catch(error => {
                    showAlert('Failed to suspend tenant', 'error', alertDashboard);
                });
        }

        // Tab functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // MCP URL copy functions
        function copyMcpUrl() {
            const mcpUrl = document.getElementById('mcpEndpointUrl').value;
            if (mcpUrl) {
                navigator.clipboard.writeText(mcpUrl).then(() => {
                    showAlert('MCP URL copied to clipboard!', 'success', alertDashboard);
                });
            }
        }

        function copyUserMcpUrl() {
            const mcpUrl = document.getElementById('userMcpUrl').value;
            if (mcpUrl) {
                navigator.clipboard.writeText(mcpUrl).then(() => {
                    showAlert('MCP URL copied to clipboard!', 'success', alertDashboard);
                });
            }
        }

        function copyCallbackUrl() {
            const callbackUrl = document.getElementById('oauthCallbackUrl').value;
            if (callbackUrl) {
                navigator.clipboard.writeText(callbackUrl).then(() => {
                    showAlert('Callback URL copied to clipboard!', 'success', alertDashboard);
                });
            }
        }

        // Test MCP connection
        function testMcpConnection() {
            const mcpUrl = document.getElementById('mcpEndpointUrl').value;
            if (mcpUrl) {
                fetch(mcpUrl + '?action=health')
                    .then(response => response.json())
                    .then(data => {
                        if (data.result && data.result.status === 'healthy') {
                            showAlert('MCP connection successful!', 'success', alertDashboard);
                        } else {
                            showAlert('MCP connection failed', 'error', alertDashboard);
                        }
                    })
                    .catch(error => {
                        showAlert('MCP connection failed', 'error', alertDashboard);
                    });
            }
        }

        function testUserMcpConnection() {
            const mcpUrl = document.getElementById('userMcpUrl').value;
            if (mcpUrl) {
                fetch(mcpUrl + '?action=health')
                    .then(response => response.json())
                    .then(data => {
                        if (data.result && data.result.status === 'healthy') {
                            showAlert('MCP connection successful!', 'success', alertDashboard);
                        } else {
                            showAlert('MCP connection failed', 'error', alertDashboard);
                        }
                    })
                    .catch(error => {
                        showAlert('MCP connection failed', 'error', alertDashboard);
                    });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshTenants').addEventListener('click', loadGlobalAdminData);
            document.getElementById('refreshUsers').addEventListener('click', loadGlobalAdminData);
            
            // MCP URL copy buttons
            document.getElementById('copyMcpUrl').addEventListener('click', copyMcpUrl);
            document.getElementById('copyUserMcpUrl').addEventListener('click', copyUserMcpUrl);
            document.getElementById('copyCallbackUrl').addEventListener('click', copyCallbackUrl);
            
            // MCP connection test buttons
            document.getElementById('testMcpConnection').addEventListener('click', testMcpConnection);
            document.getElementById('testUserMcpConnection').addEventListener('click', testUserMcpConnection);
            
            // OAuth configuration buttons
            document.getElementById('saveOAuthConfig').addEventListener('click', saveOAuthConfig);
            document.getElementById('testOAuthConnection').addEventListener('click', testOAuthConnection);
            
            initTabs();
        });
    </script>
</body>
</html>
